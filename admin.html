
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Pagamentos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; background: #f3f3f3; padding: 20px; }
    h2 { text-align: center; color: #007bff; }
    table { border-collapse: collapse; width: 100%; background: white; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #0f88eb; color: white; }
    .btn { padding: 5px 10px; margin: 5px; cursor: pointer; }
    .btn-primary { background-color: #0f88eb; color: white; border: none; }
    .hidden { display: none; }
    .input { padding: 5px; }
    .filter-bar { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h2>Painel de Pagamentos</h2>
  <div class="filter-bar">
    <button onclick="exibirTabela('pagamentos')" class="btn btn-primary">Pagamentos</button>
    <button onclick="exibirTabela('usuarios')" class="btn btn-primary">Usuários Ativos</button>
    <select id="filtroStatus" onchange="filtrarUsuarios()" class="input">
      <option value="todos">Todos</option>
      <option value="ativos">Ativos</option>
      <option value="inativos">Inativos</option>
    </select>
  </div>

  <div id="pagamentos-container">
    <input type="text" id="filtroUsuario" onkeyup="filtrarTabela()" placeholder="Buscar por usuário ou ID" class="input">
    <input type="date" id="filtroData" onchange="filtrarTabela()" class="input">
    <button onclick="exportarParaExcel()" class="btn btn-primary">Exportar para Excel</button>
    <canvas id="graficoVendas" width="400" height="100"></canvas>
    <table id="tabela-pagamentos">
      <thead>
        <tr>
          <th>Usuário</th>
          <th>ID</th>
          <th>Valor (R$)</th>
          <th>Status</th>
          <th>Data</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="usuarios-container" class="hidden">
    <table id="tabela-usuarios">
      <thead>
        <tr>
          <th>Usuário</th>
          <th>Nome</th>
          <th>Telefone</th>
          <th>Senha</th>
          <th>Expiração</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const supabaseUrl = 'https://vgsinjzkuivzecmjhflq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
    const headers = {
      'apikey': supabaseKey,
      'Authorization': 'Bearer ' + supabaseKey,
      'Content-Type': 'application/json'
    };

    let usuariosAtivos = [];

    async function carregarDados() {
      const resPag = await fetch(`${supabaseUrl}/rest/v1/pagamentos?select=*`, { headers });
      const pagamentos = await resPag.json();

      const resUsuarios = await fetch(`${supabaseUrl}/rest/v1/usuarios?select=*`, { headers });
      usuariosAtivos = await resUsuarios.json();

      preencherTabelaPagamentos(pagamentos);
      preencherTabelaUsuarios(usuariosAtivos);
      atualizarGrafico(pagamentos);
    }

    function preencherTabelaPagamentos(pagamentos) {
      const tbody = document.querySelector("#tabela-pagamentos tbody");
      tbody.innerHTML = "";
      pagamentos.forEach(p => {
        const usuarioInfo = usuariosAtivos.find(u => u.id_pagamento === p.id);
        const usuarioNome = usuarioInfo ? usuarioInfo.usuario : p.usuario;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${usuarioNome}</td>
          <td>${p.id}</td>
          <td>${parseFloat(p.valor).toFixed(2)}</td>
          <td>${p.status}</td>
          <td>${new Date(p.data).toLocaleString('pt-BR')}</td>
          <td><button onclick="navigator.clipboard.writeText('${p.id}')">Copiar ID</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function preencherTabelaUsuarios(lista) {
      const tbody = document.querySelector("#tabela-usuarios tbody");
      tbody.innerHTML = "";
      lista.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.usuario}</td>
          <td>${u.nome}</td>
          <td>${u.telefone}</td>
          <td>${u.senha}</td>
          <td>${new Date(u.expiracao).toLocaleDateString('pt-BR')}</td>
          <td><button onclick="editarUsuario('${u.id}')">Editar</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function exibirTabela(t) {
      document.getElementById("pagamentos-container").classList.toggle("hidden", t !== "pagamentos");
      document.getElementById("usuarios-container").classList.toggle("hidden", t !== "usuarios");
    }

    function filtrarTabela() { /*...*/ }
    function filtrarUsuarios() { /*...*/ }
    function exportarParaExcel() { /*...*/ }
    function atualizarGrafico(pagamentos) { /*...*/ }
    function editarUsuario(id) { alert("Função editar não implementada ainda."); }

    carregarDados();
  </script>
</body>
</html>
