<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Painel de Pagamentos</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: Arial; padding: 30px; background: #f1f1f1; }
    h1 { color: #1e88e5; text-align: center; }
    table { margin: 20px auto; border-collapse: collapse; width: 95%; background: white; }
    th, td { padding: 10px; border: 1px solid #ccc; }
    th { background-color: #1e88e5; color: white; }
    input, button { padding: 8px; margin: 5px; font-size: 14px; }
    .tabs { text-align: center; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: #eee; border: 1px solid #ccc; display: inline-block; cursor: pointer; }
    .tab.active { background: #1e88e5; color: white; }
    .hidden { display: none; }
    #modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
    #modal-content { background: white; padding: 20px; border-radius: 8px; width: 300px; }
  </style>
<style>
.id-link {
  cursor: pointer;
  color: #1e88e5;
  text-decoration: underline;
}
</style></head>
<body>
<h1>Painel de Pagamentos</h1>
<div id="login">
<p style="text-align:center;">Digite a senha:</p>
<div style="text-align:center;">
<input id="senha" placeholder="Senha de acesso" type="password"/>
<button onclick="verificarSenha()">Entrar</button>
<p id="erro" style="color:red;"></p>
</div>
</div>
<div id="painel" style="display:none;">
<div class="tabs">
<div class="tab active" onclick="trocarAba('pagamentos')">Pagamentos</div>
<div class="tab" onclick="trocarAba('usuarios')">Usuários Ativos</div>
</div>
<div id="pagamentosTab">
<input id="filtroUsuario" placeholder="Buscar por usuário ou ID" type="text"/>
<input id="filtroData" type="date"/>
<button id="exportarExcel">Exportar para Excel</button>
<canvas id="graficoVendas" style="max-width:800px; margin: 20px auto;"></canvas>
<table id="tabela">
<thead>
<tr>
<th>Usuário</th><th>ID</th><th>Valor (R$)</th><th>Status</th><th>Data</th><th></th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="hidden" id="usuariosTab">
<table id="tabelaUsuarios">
<thead>
<tr><th>Nome</th><th>Telefone</th><th>Senha</th><th>Expiração</th><th>Ações</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div id="modal">
<div id="modal-content">
<h3>Vincular Usuário</h3>
<input id="nome" placeholder="Nome completo"/><br/>
<input id="telefone" placeholder="Telefone"/><br/>
<input id="senhaUsuario" placeholder="Senha"/><br/>
<button onclick="salvarUsuario()">Salvar</button>
<button onclick="fecharModal()">Cancelar</button>
<input id="idPagamento" type="hidden"/>
<input id="valorPagamento" type="hidden"/>
</div>
</div>
<div id="modal-editar" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
<div style="background:white; padding: 20px; border-radius: 8px; width: 300px;">
<h3>Editar Usuário</h3>
<input id="edit-nome" placeholder="Nome"/><br/>
<input id="edit-telefone" placeholder="Telefone"/><br/>
<input id="edit-senha" placeholder="Senha"/><br/>
<input id="edit-expira" type="date"/><br/>
<button onclick="salvarEdicao()">Salvar</button>
<button onclick="document.getElementById('modal-editar').style.display='none'">Cancelar</button>
<input id="edit-usuario" type="hidden"/>
</div>
</div>
<script>
async function carregarUsuarios() {
  const res = await fetch("/api/usuarios");
  const lista = await res.json();
  const corpo = document.getElementById("corpoUsuarios");
  corpo.innerHTML = "";
  lista.forEach(u => {
    const linha = document.createElement("tr");

    linha.innerHTML = `
      <td>${u.nome}</td>
      <td>${u.telefone}</td>
      <td>${u.senha}</td>
      <td>${new Date(u.data_expira).toLocaleDateString()}</td>
      <td><button onclick="editarUsuario('${u.usuario}')">Editar</button></td>
    `;

    corpo.appendChild(linha);
  });
}
</script><script>
async function carregarPagamentos() {
  const res = await fetch("/api/pagamentos");
  const lista = await res.json();
  const corpo = document.getElementById("corpoPagamentos");
  corpo.innerHTML = "";
  lista.forEach(p => {
    const linha = document.createElement("tr");
    linha.innerHTML = `
      <td>${p.usuario}</td>
      <td><span class="id-link" onclick="mostrarDetalhes('${p.usuario}', this)">${p.id}</span></td>
      <td>${p.valor.toFixed(2)}</td>
      <td>${p.status}</td>
      <td>${new Date(p.data).toLocaleString()}</td>
      <td><button onclick="copiarTexto('${p.id}')">Copiar ID</button></td>
    `;
    corpo.appendChild(linha);
  });
}

async function mostrarDetalhes(usuario, elemento) {
  const jaExiste = elemento.closest("tr").nextElementSibling;
  if (jaExiste && jaExiste.classList.contains("detalhes-usuario")) {
    jaExiste.remove();
    return;
  }

  const res = await fetch("/api/usuarios");
  const lista = await res.json();
  const user = lista.find(u => u.usuario === usuario);
  if (!user) return;

  const detalhes = document.createElement("tr");
  detalhes.classList.add("detalhes-usuario");
  detalhes.innerHTML = `<td colspan="6">
    <strong>Nome:</strong> ${user.nome || "-"}<br/>
    <strong>Telefone:</strong> ${user.telefone || "-"}<br/>
    <strong>Senha:</strong> ${user.senha || "-"}<br/>
    <strong>Expira em:</strong> ${new Date(user.data_expira).toLocaleDateString()}
  </td>`;
  elemento.closest("tr").after(detalhes);
}
</script><script>
function verificarSenha() {
  const senha = document.getElementById('senha').value;
  if (senha === 'adminhera') {
    document.getElementById('painel').style.display = 'block';
    document.getElementById('login').style.display = 'none';
    carregarPagamentos();
    carregarUsuarios();
  } else {
    alert('Senha incorreta!');
  }
}
</script></body>
</html>